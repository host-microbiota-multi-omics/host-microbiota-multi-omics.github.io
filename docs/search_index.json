[["index.html", "Host-Microbiota Multi-Omics MSc Course at the University of Copenhagen Chapter 1 Introduction", " Host-Microbiota Multi-Omics MSc Course at the University of Copenhagen Ostaizka Aizpurua1 Antton Alberdi2 Last update: 2025-11-14 Chapter 1 Introduction Welcome to the Host-Microbiota Multi-Omics Course! This webbook contains the materials for the practicals of the course. University of Copenhagen, ostaizka.aizpurua@sund.ku.dk↩︎ University of Copenhagen, antton.alberdi@sund.ku.dk↩︎ "],["getting-ready.html", "Chapter 2 Getting ready 2.1 Get Visual Studio Code ready 2.2 Create a SSH connection to Mjolnir 2.3 Open the remote explorer", " Chapter 2 Getting ready 2.1 Get Visual Studio Code ready Visual Studio Code (VS Code) is a lightweight, cross-platform code editor developed by Microsoft. It’s free, open source, and supports a wide range of programming languages. Download Visual studio code: https://code.visualstudio.com/download Using the extension manager, install the following plugins: Python by Microsoft Snakemake Language by Snakemake Remote - SSH by Microsoft Remote Explorer by Microsoft 2.2 Create a SSH connection to Mjolnir Ensure you are connected to the KU VPN Menu: View &gt; Command Palette &gt; Remote-SSH: Connect to Host Add New SSH Host ssh mjolnirgate.unicph.domain Type password This should have created a SSH connection to Mjolnir, which will enable you to create a Remote Explorewr. 2.3 Open the remote explorer Explorer Connect to remote &gt; Open Folder Use the following path: /maps/projects/course_2/people/{ku-id} "],["command-line-basics.html", "Chapter 3 Command line basics", " Chapter 3 Command line basics "],["high-performance-computation.html", "Chapter 4 High Performance Computation 4.1 Modules 4.2 Screen 4.3 SLURM", " Chapter 4 High Performance Computation 4.1 Modules We will need to load two key modules to run the workshop. If you have your own conda, consider deactivating it temporarily to ensure the exercises run smoothly. # Ensure there is nothing loaded module purge # Load the relevant modules module load snakemake/9.4.0 module load miniconda/py39_23.1 # List the loaded modules module list Use should see exactly this: Currently Loaded Modulefiles: 1) miniconda/py39_23.1 2) snakemake/9.4.0 4.2 Screen Screen is a simple tool that keeps your command-line session running on a server even if your internet drops or you close your laptop. Think of it like putting your terminal in a locker—you can step away and later unlock it to find everything exactly where you left it. It also lets you make several “tabs” (windows) inside one SSH login and switch between them. On HPC clusters where tasks can run for hours, starting them inside Screen keeps them safe and easy to rejoin. It’s lightweight and saves you from losing work. To create a screen session for the entire duration of the workshop: screen -S hmmo_screen To get out from the session, you must type ctrl+a d To re-enter the session, simply: screen -r hmmo_screen And to close the session, just type exit. 4.3 SLURM "],["snakemake.html", "Chapter 5 Snakemake", " Chapter 5 Snakemake "],["course-environment.html", "Chapter 6 Course environment 6.1 Your directory 6.2 Raw data", " Chapter 6 Course environment The computational exercises of the course will be conducted in the following project in Mjolnir: /projects/course_1 You can access it using cd /projects/course_1 or visualise its contents using ls -lah /projects/course_1. This directory contains four folders: apps: it contains the snakemake pipelines you will use for processing the samples. data: it contains the raw data to be used in the exercises. people: it contains the folders of the individual users where your personal data will be stored. scratch: some software will use this directory to store temporary data. 6.1 Your directory This is the directory that can be accessed and edited by each user. All the computed files will be stored here. To access your directory you need to know your ku-id. /projects/course_1/people/{ku-id} 6.2 Raw data The raw data for the different studies that will be used in the course are found in different folders within the data director: /projects/course_1/data/lizards /projects/course_1/data/corvids "],["quality-filtering.html", "Chapter 7 Quality filtering", " Chapter 7 Quality filtering This rule performs the first major preprocessing step in the workflow: quality-control, trimming, and filtering of raw paired-end sequencing reads using fastp. It takes each sample’s raw FASTQ files and removes adapters, trims low-quality bases, filters out low-complexity or artifact-rich reads (including common NovaSeq poly-G/X issues), and outputs cleaned read pairs. These cleaned FASTQ files form the high-quality input for all downstream host–microbiota analyses, ensuring that later steps—such as host-read removal, taxonomic profiling, or assembly—are not biased by sequencing artifacts. In addition to generating cleaned reads, the rule produces HTML and JSON quality-control reports summarizing read quality before and after processing. The rule also handles software environment setup through module loading and scales memory/runtime requirements automatically based on the size of the input files, making it robust on HPC systems. rule fastp: input: r1=f&quot;{OUTPUT_DIR}/data/reads/{{sample}}_1.fq.gz&quot;, r2=f&quot;{OUTPUT_DIR}/data/reads/{{sample}}_2.fq.gz&quot; output: r1=f&quot;{OUTPUT_DIR}/preprocessing/fastp/{{sample}}_1.fq.gz&quot;, r2=f&quot;{OUTPUT_DIR}/preprocessing/fastp/{{sample}}_2.fq.gz&quot;, html=f&quot;{OUTPUT_DIR}/preprocessing/fastp/{{sample}}.html&quot;, json=f&quot;{OUTPUT_DIR}/preprocessing/fastp/{{sample}}.json&quot; shell: &quot;&quot;&quot; module load {params.fastp_module} fastp \\ --in1 {input.r1} --in2 {input.r2} \\ --out1 {output.r1} --out2 {output.r2} \\ --trim_poly_g \\ --trim_poly_x \\ --low_complexity_filter \\ --n_base_limit 5 \\ --qualified_quality_phred 20 \\ --length_required 60 \\ --thread {threads} \\ --html {output.html} \\ --json {output.json} \\ --adapter_sequence AGATCGGAAGAGCACACGTCTGAACTCCAGTCA \\ --adapter_sequence_r2 AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT &quot;&quot;&quot; "],["host-mapping.html", "Chapter 8 Host mapping", " Chapter 8 Host mapping This rule prepares a reference genome so it can be efficiently used for read alignment with Bowtie2. It takes a FASTA file for a given host genome and runs bowtie2-build to generate the index files that Bowtie2 requires for fast and accurate mapping. Only one of the produced index files is listed as the output, but the command generates the full set of Bowtie2 index components. This indexing step is essential because alignment tools rely on these precomputed structures to rapidly search the genome during mapping. In addition to building the index, the rule also saves a copy of the reference FASTA alongside the index under a standardized naming scheme, ensuring consistency for downstream processes that expect the reference to be colocated with its index. The rule loads the appropriate Bowtie2 module and includes adaptive memory and runtime estimation based on the size of the reference genome, making it robust for small microbial genomes as well as larger host genomes. rule reference_index: input: f&quot;{OUTPUT_DIR}/data/references/{{reference}}.fna&quot; output: index=f&quot;{OUTPUT_DIR}/data/references/{{reference}}.rev.1.bt2&quot; params: basename=f&quot;{OUTPUT_DIR}/data/references/{{reference}}&quot; shell: &quot;&quot;&quot; module load {params.bowtie2_module} bowtie2-build {input} {params.basename} cat {input} &gt; {params.basename}.fna &quot;&quot;&quot; "],["host-genome-mapping.html", "Chapter 9 Host genome mapping", " Chapter 9 Host genome mapping This rule maps each sample’s quality-filtered paired-end reads to its corresponding reference genome using Bowtie2, producing a sorted BAM file that is ready for downstream analyses such as host read removal, quantification, or coverage estimation. It uses the Bowtie2 index generated in the previous step and the cleaned FASTQ files from fastp as inputs. The mapping is performed with multiple threads for efficiency, and the output is streamed directly into samtools to convert the SAM alignment to BAM format and sort it in a single streamlined command. By linking each sample to its appropriate reference through SAMPLE_TO_REFERENCE, the rule flexibly supports host–microbiota workflows where different samples may require different reference genomes. Memory and runtime are scaled according to the size of the input reads, ensuring robust performance across varied dataset sizes. The result is a properly formatted, sorted BAM file that downstream tools can use without additional preprocessing. rule reference_map: input: index=lambda wildcards: expand( f&quot;{OUTPUT_DIR}/data/references/{{reference}}.rev.1.bt2&quot;, reference=[SAMPLE_TO_REFERENCE[wildcards.sample]] ), r1=f&quot;{OUTPUT_DIR}/preprocessing/fastp/{{sample}}_1.fq.gz&quot;, r2=f&quot;{OUTPUT_DIR}/preprocessing/fastp/{{sample}}_2.fq.gz&quot; output: f&quot;{OUTPUT_DIR}/preprocessing/bowtie2/{{sample}}.bam&quot; params: basename=lambda wildcards: f&quot;{OUTPUT_DIR}/data/references/{SAMPLE_TO_REFERENCE[wildcards.sample]}&quot; shell: &quot;&quot;&quot; module load {params.bowtie2_module} {params.samtools_module} bowtie2 -x {params.basename} -1 {input.r1} -2 {input.r2} -p {threads} | samtools view -bS - | samtools sort -o {output} &quot;&quot;&quot; "],["mapping-statistics.html", "Chapter 10 Mapping statistics", " Chapter 10 Mapping statistics This rule computes alignment quality and summary statistics for each sorted BAM file generated during mapping. Using several samtools subcommands, it produces metrics that describe how well the reads aligned to the reference genome—information essential for evaluating host-read removal efficiency, assessing sequencing quality, and feeding into MultiQC reports. The BAM file is indexed to enable rapid random access, while flagstat, idxstats, and stats each provide different levels of summary: overall alignment rates, per-reference sequence counts, and more detailed alignment metrics. All these outputs are written into a dedicated samtools directory and follow a consistent naming structure, making them easy to collect later for QC visualization and downstream processing. The rule loads the necessary samtools module and uses light computational resources, since generating these QC summaries is relatively inexpensive compared to alignment. rule samtools_stats: input: rules.reference_map.output output: bai = f&quot;{OUTPUT_DIR}/preprocessing/samtools/{{sample}}.bam.bai&quot;, flagstat = f&quot;{OUTPUT_DIR}/preprocessing/samtools/{{sample}}.flagstat.txt&quot;, idxstats = f&quot;{OUTPUT_DIR}/preprocessing/samtools/{{sample}}.idxstats.txt&quot;, stats = f&quot;{OUTPUT_DIR}/preprocessing/samtools/{{sample}}.stats.txt&quot; shell: &quot;&quot;&quot; module load {params.samtools_module} samtools index {input} {output.bai} samtools flagstat {input} &gt; {output.flagstat} samtools idxstats {input} &gt; {output.idxstats} samtools stats {input} &gt; {output.stats} &quot;&quot;&quot; "],["host-microbiota-split.html", "Chapter 11 Host-microbiota split", " Chapter 11 Host-microbiota split This rule takes the aligned BAM file and separates mapped and unmapped read pairs, effectively splitting host-origin reads from metagenomic reads. Unmapped reads (i.e., those that did not align to the host reference) are extracted and converted back into paired FASTQ files, forming the metagenomic read set used for downstream microbiome profiling or assembly. At the same time, mapped reads are retained in a host-only BAM file, which can be used for host genomics analyses or simply for quality assessment. In addition to generating the split read files, the rule also counts how many reads and how many total bases fall into the metagenomic vs. host categories. These summary files are useful for evaluating host contamination, sequencing depth distribution, and the overall success of the host-depletion strategy. The process relies on samtools to filter BAM records by mapping flags and uses simple awk commands to tally base counts, making it a compact but crucial step in workflows that jointly analyze host and microbiota data. rule split_reads: input: f&quot;{OUTPUT_DIR}/preprocessing/bowtie2/{{sample}}.bam&quot; output: r1=f&quot;{OUTPUT_DIR}/preprocessing/final/{{sample}}_1.fq.gz&quot;, r2=f&quot;{OUTPUT_DIR}/preprocessing/final/{{sample}}_2.fq.gz&quot;, metareads=f&quot;{OUTPUT_DIR}/preprocessing/final/{{sample}}.metareads&quot;, metabases=f&quot;{OUTPUT_DIR}/preprocessing/final/{{sample}}.metabases&quot;, bam=f&quot;{OUTPUT_DIR}/preprocessing/final/{{sample}}.bam&quot;, hostreads=f&quot;{OUTPUT_DIR}/preprocessing/final/{{sample}}.hostreads&quot;, hostbases=f&quot;{OUTPUT_DIR}/preprocessing/final/{{sample}}.hostbases&quot; shell: &quot;&quot;&quot; module load {params.bowtie2_module} {params.samtools_module} samtools view -b -f12 -@ {threads} {input} | samtools fastq -@ {threads} -1 {output.r1} -2 {output.r2} - samtools view -b -f12 -@ {threads} {input} | samtools view -c - &gt; {output.metareads} samtools view -f12 -@ {threads} {input} | awk &#39;{{sum += length($10)}} END {{print sum}}&#39; &gt; {output.metabases} samtools view -b -F12 -@ {threads} {input} | samtools sort -@ {threads} -o {output.bam} - samtools view -b -F12 -@ {threads} {input} | samtools view -c - &gt; {output.hostreads} samtools view -F12 -@ {threads} {input} | awk &#39;{{sum += length($10)}} END {{print sum}}&#39; &gt; {output.hostbases} &quot;&quot;&quot; "],["sketching.html", "Chapter 12 Sketching", " Chapter 12 Sketching "],["assembly-binning.html", "Chapter 13 Assembly + binning", " Chapter 13 Assembly + binning "],["taxonomic-annotation.html", "Chapter 14 Taxonomic annotation", " Chapter 14 Taxonomic annotation "],["functional-annotation.html", "Chapter 15 Functional annotation", " Chapter 15 Functional annotation "],["dereplication.html", "Chapter 16 Dereplication", " Chapter 16 Dereplication "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
